<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„Ø§Ø­Ø© ÙˆØ§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø°ÙƒÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css" rel="stylesheet">
    <style>
        /* Your existing CSS remains here */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; background: #000; overflow: hidden; height: 100vh; }
        #map { height: 100vh; width: 100%; }
        .navigation-hud { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); color: white; padding: 20px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); z-index: 1000; width: 350px; text-align: center; }
        .speed-indicator { font-size: 2.5rem; font-weight: bold; color: #00ff88; text-shadow: 0 0 10px rgba(0, 255, 136, 0.5); margin-bottom: 10px; }
        .distance-info { display: flex; justify-content: space-between; margin: 15px 0; font-size: 1.1rem; }
        .eta-info { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); padding: 10px; border-radius: 10px; margin: 10px 0; }
        .controls-panel { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); color: white; padding: 15px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 1000; width: 300px; }
        .location-panel { position: absolute; bottom: 20px; left: 20px; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); color: white; padding: 15px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 1000; width: 320px; }
        .destination-panel { position: absolute; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); color: white; padding: 15px; border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.1); z-index: 1000; width: 300px; }
        .btn-modern { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); border: none; color: white; padding: 10px 15px; border-radius: 8px; margin: 3px; transition: all 0.3s ease; font-weight: 500; }
        .btn-modern:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); color: white; }
        .btn-danger-modern { background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%); }
        .btn-success-modern { background: linear-gradient(45deg, #00d2ff 0%, #3a7bd5 100%); }
        .form-control-modern { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; border-radius: 8px; padding: 8px 12px; }
        .compass { width: 50px; height: 50px; border-radius: 50%; background: radial-gradient(circle, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; margin: 10px auto; position: relative; box-shadow: 0 0 20px rgba(102, 126, 234, 0.3); }
        .compass::before { content: 'â†‘'; color: white; font-size: 1.5rem; font-weight: bold; }
        .glow-text { text-shadow: 0 0 10px currentColor; }
        .info-item { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; padding: 5px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .info-label { font-weight: 500; opacity: 0.8; }
        .info-value { font-weight: bold; color: #00ff88; }
        .destination-btn { width: 100%; margin-bottom: 8px; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px; border-radius: 8px; transition: all 0.3s ease; }
        .destination-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateX(5px); color: white; }
        .destination-btn.active { background: linear-gradient(45deg, #667eea 0%, #764ba2 100%); border-color: #667eea; }

        /* --- START: Mobile Responsive Styles --- */
        @media (max-width: 768px) {
            .navigation-hud {
                width: 90%; /* Ø£Ø¹Ø±Ø¶ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ø´Ø© */
                padding: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´ÙˆØ© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© */
                top: 10px; /* ØªÙ‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
            }
            .speed-indicator {
                font-size: 2rem; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ø³Ø±Ø¹Ø© */
                margin-bottom: 5px;
            }
            .distance-info {
                font-size: 0.9rem; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø®Ø· Ø§Ù„Ù…Ø³Ø§ÙØ© */
                margin: 8px 0;
            }
            .eta-info {
                padding: 8px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´ÙˆØ© */
                font-size: 0.9rem; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø®Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
            }
            .eta-info span { /* Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ø§Ù„Ù†Øµ Ø¯Ø§Ø®Ù„ ETA */
                font-size: 0.9rem;
            }

            .controls-panel {
                width: 200px; /* ØªØµØºÙŠØ± Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
                right: 10px; /* ØªÙ‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„ÙŠÙ…Ù†Ù‰ */
                top: 10px; /* Ù…Ø­Ø§Ø°Ø§Ø© Ù…Ø¹ Ø£Ø¹Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø© */
                padding: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´ÙˆØ© */
                z-index: 1001; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ±Ù‡ ÙÙˆÙ‚ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø± */
            }
            .controls-panel h6 {
                font-size: 1rem; /* ØªØµØºÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
                margin-bottom: 10px;
            }
            /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØªØ³ØªØ®Ø¯Ù… w-100ØŒ ÙˆÙ‡Ùˆ Ø¬ÙŠØ¯ Ù„Ù„ØªÙƒØ¯ÙŠØ³ Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠ */
            .btn-modern, .btn-success-modern, .btn-danger-modern { /* ØªØ¹Ø¯ÙŠÙ„ Ø¹Ø§Ù… Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
                padding: 8px 12px; /* ØªÙ‚Ù„ÙŠÙ„ Ø­Ø´ÙˆØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
                font-size: 0.85rem; /* ØªØµØºÙŠØ± Ø®Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
            }
            .form-check-label {
                font-size: 0.85rem; /* ØªØµØºÙŠØ± Ø®Ø· Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ */
            }

            .location-panel {
                width: 220px; /* ØªØµØºÙŠØ± Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
                left: 10px; /* ØªÙ‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø­Ø§ÙØ© Ø§Ù„ÙŠØ³Ø±Ù‰ */
                bottom: 10px; /* ØªÙ‚Ø±ÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ */
                padding: 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø­Ø´ÙˆØ© */
            }
            .location-panel h6 {
                font-size: 1rem; /* ØªØµØºÙŠØ± Ø¹Ù†ÙˆØ§Ù† Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
                margin-bottom: 10px;
            }
            .info-item {
                margin: 5px 0; /* ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ§Øª Ø¨ÙŠÙ† Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
                padding: 3px 0;
            }
            .info-label, .info-value { /* Ø§Ø³ØªÙ‡Ø¯Ø§Ù Ù†ØµÙˆØµ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
                font-size: 0.85rem;
            }
            .compass {
                width: 45px; /* ØªØµØºÙŠØ± Ø­Ø¬Ù… Ø§Ù„Ø¨ÙˆØµÙ„Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ */
                height: 45px;
                margin-top: 8px;
            }
            .compass::before {
                font-size: 1.3rem; /* ØªØµØºÙŠØ± Ø³Ù‡Ù… Ø§Ù„Ø¨ÙˆØµÙ„Ø© */
            }
        }

        /* ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ (Ù…Ø«Ù„ Ø¹Ø±Ø¶ Ù‡Ø§ØªÙ ØµØºÙŠØ±) */
        @media (max-width: 500px) {
            .speed-indicator {
                font-size: 1.8rem;
            }
            .distance-info {
                font-size: 0.8rem;
                flex-direction: column; /* Ø¬Ø¹Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆÙ‚ÙŠÙ…ØªÙ‡Ø§ ØªØ­Øª Ø¨Ø¹Ø¶ */
                align-items: center; /* ØªÙˆØ³ÙŠØ·Ù‡Ù…Ø§ */
            }
            .distance-info span:first-child { /* Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆÙ‚ÙŠÙ…ØªÙ‡Ø§ */
                margin-bottom: 3px;
            }
            .eta-info, .eta-info span {
                font-size: 0.8rem;
            }

            .controls-panel {
                width: 150px; /* ØªØµØºÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
                padding: 8px;
            }
            .controls-panel h6 {
                font-size: 0.9rem;
            }
            .btn-modern, .btn-success-modern, .btn-danger-modern {
                padding: 6px 10px; /* ØªÙ‚Ù„ÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠ Ù„Ø­Ø´ÙˆØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
                font-size: 0.75rem; /* ØªØµØºÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ø®Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
            }

            .location-panel {
                width: 180px; /* ØªØµØºÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
                padding: 8px;
            }
            .location-panel h6 {
                font-size: 0.9rem;
            }
            .info-label, .info-value {
                font-size: 0.75rem;
            }
            .compass {
                width: 35px; /* ØªØµØºÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ù„Ø¨ÙˆØµÙ„Ø© */
                height: 35px;
            }
            .compass::before {
                font-size: 1rem; /* ØªØµØºÙŠØ± Ø¥Ø¶Ø§ÙÙŠ Ù„Ø³Ù‡Ù… Ø§Ù„Ø¨ÙˆØµÙ„Ø© */
            }
        }
        /* --- END: Mobile Responsive Styles --- */
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="navigation-hud">
        <div class="speed-indicator glow-text" id="current-speed">0 ÙƒÙ…/Ø³</div>
        <div class="distance-info">
            <span>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span>
            <span id="remaining-distance" class="glow-text">-- ÙƒÙ…</span>
        </div>
        <div class="eta-info">
            <strong>Ø§Ù„ÙˆØµÙˆÙ„ Ø®Ù„Ø§Ù„: <span id="eta-time">-- Ø¯Ù‚ÙŠÙ‚Ø©</span></strong>
        </div>
    </div>
    
    <div class="controls-panel">
        <h6 class="text-center mb-3 glow-text">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ù„Ø§Ø­Ø©</h6>
        <button id="find-nearest-btn" class="btn btn-success-modern w-100 mb-2">ğŸ” Ø£ÙˆØ¬Ø¯ Ø£Ù‚Ø±Ø¨ ÙˆØ¬Ù‡Ø©</button>
        <button id="recenter-btn" class="btn btn-modern w-100 mb-2">ğŸ“ ØªÙˆØ³ÙŠØ· Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
        <div class="form-check form-switch mt-2">
            <input class="form-check-input" type="checkbox" id="auto-center" checked>
            <label class="form-check-label text-white" for="auto-center">
                ØªÙˆØ³ÙŠØ· Ø§Ù„Ø®Ø±ÙŠØ·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
            </label>
        </div>
    </div>
    
    <div class="location-panel">
        <h6 class="text-center mb-3 glow-text">ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª GPS</h6>
        <div class="info-item">
            <span class="info-label">Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:</span>
            <span class="info-value" id="coordinates">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ¯...</span>
        </div>
        <div class="info-item">
            <span class="info-label">Ø§Ù„Ø¯Ù‚Ø©:</span>
            <span class="info-value" id="accuracy">-- Ù…ØªØ±</span>
        </div>
        <div class="compass" id="compass"></div>
    </div>

    <script>
        // Initialize Mapbox
        mapboxgl.accessToken = 'pk.eyJ1IjoibW9oYW1tZWQtMTMzMSIsImEiOiJjbHY3dHFsaDcwZWcyMm9xaXBmdHVibm11In0.BDSWP06iKFsCOxq0IwxLBg';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/navigation-night-v1',
            center: [35.2137, 31.7683],
            zoom: 13
        });

        // Variables
        let userLocation = null;
        let userMarker = null;
        let currentRoute = null;
        let destinationMarkers = [];
        let activeDestinationKey = null;

        // Get references to UI elements
        const coordinatesSpan = document.getElementById('coordinates');
        const accuracySpan = document.getElementById('accuracy');
        const speedIndicator = document.getElementById('current-speed');
        const compass = document.getElementById('compass');
        const remainingDistanceSpan = document.getElementById('remaining-distance');
        const etaSpan = document.getElementById('eta-time');
        const autoCenterCheckbox = document.getElementById('auto-center');

        const destinations = {
            hospital: { name: "Ù…Ø³ØªØ´ÙÙ‰ Ø§Ù„Ù…Ù‚Ø§ØµØ¯", coordinates: [35.2167, 31.7697], icon: "ğŸ¥" },
            'gas-station': { name: "Ù…Ø­Ø·Ø© ÙˆÙ‚ÙˆØ¯", coordinates: [35.2098, 31.7645], icon: "â›½" },
            albireh: { name: "Ø§Ù„Ø¨ÙŠØ±Ø©", coordinates: [35.2143, 31.9072], icon: "ğŸ™ï¸" },
            birzeit: { name: "Ø¬Ø§Ù…Ø¹Ø© Ø¨ÙŠØ±Ø²ÙŠØª", coordinates: [35.2038, 31.9707], icon: "ğŸ›ï¸" }
        };

        map.on('load', () => {
            addDestinationMarkers();
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    position => {
                        updateUserLocation(position);
                    },
                    error => {
                        handleGeolocationError(error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0 
                    }
                );
            } else {
                alert("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ØªØµÙØ­ Ø£Ø­Ø¯Ø«.");
            }
        });

        function addDestinationMarkers() {
            destinationMarkers.forEach(marker => marker.remove());
            destinationMarkers = [];
            Object.keys(destinations).forEach(key => {
                const el = document.createElement('div');
                el.innerHTML = `<div style="background: #00ff88; color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">${destinations[key].icon}</div>`;
                const marker = new mapboxgl.Marker(el)
                    .setLngLat(destinations[key].coordinates)
                    .setPopup(new mapboxgl.Popup().setHTML(`
                        <div style="text-align: center; padding: 10px;">
                            <h6>${destinations[key].name}</h6>
                            <button onclick="calculateRouteFromCurrent('${key}')" 
                                    style="background: #00ff88; color: white; border: none; 
                                           padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                                Ø§Ù†Ø·Ù„Ù‚ Ø¥Ù„Ù‰ Ù‡Ù†Ø§
                            </button>
                        </div>
                    `))
                    .addTo(map);
                destinationMarkers.push(marker);
            });
        }

        function updateUserLocation(position) {
            const { latitude, longitude, accuracy, heading, speed } = position.coords;
            
            coordinatesSpan.textContent = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            accuracySpan.textContent = `${Math.round(accuracy)} Ù…ØªØ±`;
            
            const currentSpeedKmh = speed ? (speed * 3.6).toFixed(1) : 0;
            speedIndicator.textContent = `${currentSpeedKmh} ÙƒÙ…/Ø³`;
            
            if (typeof heading === 'number' && !isNaN(heading)) {
                compass.style.transform = `rotate(${heading}deg)`;
            } else {
                if (window.DeviceOrientationEvent && !window.deviceOrientationListenerAttached) {
                    window.addEventListener('deviceorientation', handleOrientation, true);
                    window.deviceOrientationListenerAttached = true; 
                }
            }
            
            if (!userMarker) {
                const el = createUserMarker();
                userMarker = new mapboxgl.Marker(el)
                    .setLngLat([longitude, latitude])
                    .addTo(map);
            } else {
                userMarker.setLngLat([longitude, latitude]);
            }
            
            if (autoCenterCheckbox.checked) {
                const cameraOptions = {
                    center: [longitude, latitude],
                    zoom: 16, 
                    essential: true 
                };
                if (typeof heading === 'number' && !isNaN(heading)) {
                    cameraOptions.bearing = heading;
                }
                cameraOptions.pitch = 50; 
                map.flyTo(cameraOptions);
            }
            
            userLocation = { lat: latitude, lng: longitude };
        }
        window.deviceOrientationListenerAttached = false;

        function handleOrientation(event) {
            if (navigator.geolocation && typeof (navigator.geolocation.getCurrentPosition(p => p.coords.heading)) !== 'number') {
                 if (event.alpha !== null) {
                    compass.style.transform = `rotate(${-event.alpha}deg)`;
                }
            }
        }

        function handleGeolocationError(error) {
            let message;
            switch (error.code) {
                case error.PERMISSION_DENIED: message = "ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ."; break;
                case error.POSITION_UNAVAILABLE: message = "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ´ØºÙŠÙ„ GPS."; break;
                case error.TIMEOUT: message = "Ø§Ù†ØªÙ‡Øª Ù…Ù‡Ù„Ø© Ø·Ù„Ø¨ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª Ø£Ùˆ Ø¥Ø´Ø§Ø±Ø© GPS."; break;
                default: message = "Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ/Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹.";
            }
            console.error("GPS Error:", error);
            alert(message);
            coordinatesSpan.textContent = "ØºÙŠØ± Ù…ØªÙˆÙØ±";
            accuracySpan.textContent = "--";
            speedIndicator.textContent = "0 ÙƒÙ…/Ø³";
        }

        function createUserMarker() {
            const el = document.createElement('div');
            el.innerHTML = `
                <div style="width: 20px; height: 20px; background: #00ff88; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 15px rgba(0, 255, 136, 0.7);"></div>
            `;
            return el;
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; 
        }

        function findNearestDestination() {
            if (!userLocation) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');
                return;
            }
            let nearestDistance = Infinity;
            let nearestDestinationKey = null;
            Object.keys(destinations).forEach(key => {
                const dest = destinations[key];
                const distance = calculateDistance(userLocation.lat, userLocation.lng, dest.coordinates[1], dest.coordinates[0]);
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                    nearestDestinationKey = key;
                }
            });
            if (nearestDestinationKey) {
                calculateRoute(userLocation, destinations[nearestDestinationKey].coordinates);
                alert(`Ø£Ù‚Ø±Ø¨ ÙˆØ¬Ù‡Ø© Ù‡ÙŠ: ${destinations[nearestDestinationKey].name} (${nearestDistance.toFixed(2)} ÙƒÙ…)`);
                activeDestinationKey = nearestDestinationKey;
            }
        }

        function calculateRouteFromCurrent(destinationKey) {
            if (!userLocation) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ');
                return;
            }
            if (destinations[destinationKey]) {
                calculateRoute(userLocation, destinations[destinationKey].coordinates);
                activeDestinationKey = destinationKey;
            }
        }

        async function calculateRoute(start, end) {
            try {
                const response = await fetch(
                    `https://api.mapbox.com/directions/v5/mapbox/driving/${start.lng},${start.lat};${end[0]},${end[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`
                );
                const data = await response.json();
                if (data.routes && data.routes.length > 0) {
                    currentRoute = data.routes[0];
                    if (map.getSource('route')) {
                        map.removeLayer('route');
                        map.removeSource('route');
                    }
                    map.addSource('route', {
                        type: 'geojson',
                        data: { type: 'Feature', properties: {}, geometry: currentRoute.geometry }
                    });
                    map.addLayer({
                        id: 'route', type: 'line', source: 'route',
                        layout: { 'line-join': 'round', 'line-cap': 'round' },
                        paint: { 'line-color': '#00ff88', 'line-width': 4 }
                    });
                    const distance = (currentRoute.distance / 1000).toFixed(1);
                    remainingDistanceSpan.textContent = `${distance} ÙƒÙ…`;
                    const etaMinutes = Math.round(currentRoute.duration / 60);
                    etaSpan.textContent = `${etaMinutes} Ø¯Ù‚ÙŠÙ‚Ø©`;
                    const bounds = new mapboxgl.LngLatBounds();
                    bounds.extend([start.lng, start.lat]);
                    bounds.extend(end);
                    map.fitBounds(bounds, { padding: 50 });
                } else {
                    alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¬Ù‡Ø©.');
                }
            } catch (error) {
                console.error('Route calculation error:', error);
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹.');
            }
        }

        function clearRoute() {
            if (map.getSource('route')) {
                map.removeLayer('route');
                map.removeSource('route');
                remainingDistanceSpan.textContent = '-- ÙƒÙ…';
                etaSpan.textContent = '-- Ø¯Ù‚ÙŠÙ‚Ø©';
                currentRoute = null;
                activeDestinationKey = null;
            }
        }

        document.getElementById('recenter-btn').addEventListener('click', () => {
            if (userLocation) {
                const options = {
                    center: [userLocation.lng, userLocation.lat],
                    zoom: 15
                };
                if (autoCenterCheckbox.checked) {
                    const currentHeading = userMarker && userMarker.getElement().style.transform.includes('rotate') ?
                                           parseFloat(userMarker.getElement().style.transform.replace(/[^\d.-]/g, '')) : null;
                    if (currentHeading !== null && !isNaN(currentHeading)) {
                        options.bearing = currentHeading;
                    }
                    options.pitch = 50; 
                    options.zoom = 16;
                }
                map.flyTo(options);
            } else {
                alert('Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ³ÙŠØ·.');
            }
        });

        document.getElementById('find-nearest-btn').addEventListener('click', findNearestDestination);
        window.calculateRouteFromCurrent = calculateRouteFromCurrent;
    </script>
</body>
</html>
